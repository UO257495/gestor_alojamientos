<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<th:block th:replace="~{fragments/head :: head ('Buscador de alojamientos')}"></th:block>
</head>
<body>

	<div th:replace="~{fragments/menu :: principal}"></div>

    <section class="container contenido">

        <!-- MOSTRAR ESTO SI NO HAY SESIÓN -->
        <div sec:authorize="isAnonymous()" class="d-flex justify-content-center align-items-center vh-100 bg-light">
            <div class="text-center p-5 shadow rounded bg-white" style="max-width: 600px;">
                
            
                <!-- Texto principal -->
                <h1 class="display-5 mb-3">¡Bienvenid@ a tu próxima escapada!</h1>
                <p class="lead mb-4">
                    Para poder reservar alojamientos y disfrutar de todas nuestras funcionalidades,
                    por favor inicia sesión o crea una cuenta nueva.
                </p>
                
                <!-- Botones -->
                <div class="d-flex justify-content-center gap-3">
                    <a th:href="@{/login}" class="btn btn-success btn-lg">
                        <i class="fa-solid fa-right-to-bracket me-2"></i> Inicia sesión
                    </a>
                    <a th:href="@{/gestion/usuarios/detalle}" class="btn btn-outline-primary btn-lg">
                        <i class="fa-solid fa-user-plus me-2"></i> Regístrate
                    </a>
                </div>
            </div>
        </div>


         <!-- MOSTRAR ESTO SI HAY SESIÓN -->
        <div sec:authorize="isAuthenticated()">
            <h1 class="mb-4">
                <i class="fa-solid fa-magnifying-glass text-secondary"></i>
                Buscador de alojamientos
            </h1>

            <div class="tab-content">

                <section class="container my-3">

                    <!-- FORMULARIO DE BÚSQUEDA -->
                    <form th:action="@{/buscarAlojamientos}" th:object="${busquedaForm}" method="get" id="busquedaForm" class="mb-4">

                        <div class="mb-3 row">
                            <label for="ubicacioin" class="col-sm-2 col-form-label">Ubicación</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="ubicacion" th:field="*{ubicacion}"  />
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="personas" class="col-sm-2 col-form-label">Personas</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" id="personas" th:field="*{personas}" min="1" />
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label">Fechas</label>
                            <div class="col-sm-5">
                                <input type="date" class="form-control" id="fechaInicio" th:field="*{fechaInicio}" />
                            </div>
                            <div class="col-sm-5">
                                <input type="date" class="form-control" id="fechaFin" th:field="*{fechaFin}" />
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-search"></i> Buscar
                            </button>
                        </div>
                    </form>
                </section>
            </div>

            <!-- MAPA -->
            <div id="map" style="height: 400px; border-radius: 10px; margin-top: 20px;"></div>


            <!-- LISTADO -->
            <div id="resultados" class="row gy-3">
                <div class="col-md-4 mb-3" th:each="alojamiento : ${resultados}">
                    <div class="card">
                        <img th:src="@{${alojamiento.foto}}" class="card-img-top" alt="Foto de alojamiento">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${alojamiento.nombre}">Nombre</h5>
                            <p class="card-text" th:text="${alojamiento.direccion}">Ubicación</p>
                            <p class="card-text">Capacidad: <span th:text="${alojamiento.capacidad}">0</span> personas</p>
                            <a th:href="@{'/reservar/' + ${alojamiento.id}}" class="btn btn-verde">RESERVAR</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </section>


    <div th:replace="~{fragments/menu :: pie}"></div>

	<th:block th:replace="~{fragments/scripts :: scripts}"></th:block>

    <script th:inline="javascript">
        /* <![CDATA[ */
        const map = L.map('map').setView([43.36, -5.85], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = L.featureGroup().addTo(map);

        // Función para pintar alojamientos en el mapa y listado
        function pintarAlojamientos(alojamientos) {
            markers.clearLayers();
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '';

            alojamientos.forEach(a => {
                const lat = parseFloat(a.latitud);
                const lon = parseFloat(a.longitud);
                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.marker([lat, lon])
                    .bindPopup(`
                        <div class="card" style="width: 200px;">
                            <img src="${a.foto}" class="card-img-top" alt="Foto de alojamiento" style="height:120px; object-fit:cover;">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">${a.nombre}</h6>
                                <p class="card-text mb-2">Capacidad: ${a.capacidad} personas</p>
                                <a href="/reservar/${a.id}" class="btn btn-success btn-sm w-100">RESERVAR</a>
                            </div>
                        </div>
                    `);
                    markers.addLayer(marker);
                }

                // Listado HTML
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                card.innerHTML = `
                    <div class="card">
                        <img src="${a.foto}" class="card-img-top" alt="Foto de alojamiento">
                        <div class="card-body">
                            <h5 class="card-title">${a.nombre}</h5>
                            <p class="card-text">${a.direccion}</p>
                            <p class="card-text">Capacidad: ${a.capacidad} personas</p>
                            <a href="/reservar/${a.id}" class="btn btn-success btn-sm w-100">RESERVAR</a>
                        </div>
                    </div>
                `;
                resultadosDiv.appendChild(card);
            });

            if (alojamientos.length > 0) {
                map.fitBounds(markers.getBounds().pad(0.2));
            }
        }

        // Cargar todos los alojamientos al inicio
        fetch('/api/alojamientos')
            .then(res => res.json())
            .then(alojamientos => pintarAlojamientos(alojamientos));

        // Evento del formulario para filtrar
        const form = document.getElementById('busquedaForm');
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                ubicacion: document.getElementById('ubicacion').value || null,
                personas: parseInt(document.getElementById('personas').value) || null,
                fechaInicio: document.getElementById('fechaInicio').value || null,
                fechaFin: document.getElementById('fechaFin').value || null
            };

            fetch('/api/alojamientos/buscar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(alojamientos => pintarAlojamientos(alojamientos));
        });

        /* ]]> */
    </script>


</body>
</html>